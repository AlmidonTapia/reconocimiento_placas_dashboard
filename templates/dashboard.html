<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reconocimiento de Placas en Tiempo Real</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root {
            --primary-color: #4a80ff;
            --background-color: #f4f7fc;
            --card-background: #ffffff;
            --text-color: #333333;
            --subtle-text-color: #777777;
            --border-color: #e0e0e0;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Poppins", -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg,
                    rgba(74, 128, 255, 0.1) 0%,
                    rgba(116, 185, 255, 0.08) 25%,
                    rgba(244, 247, 252, 0.95) 50%,
                    rgba(167, 199, 231, 0.08) 75%,
                    rgba(74, 128, 255, 0.1) 100%);
            min-height: 100vh;
            color: var(--text-color);
            line-height: 1.6;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--text-color);
            padding: 2rem;
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-color);
            letter-spacing: -0.025em;
        }

        .header p {
            font-size: 1.1rem;
            color: var(--subtle-text-color);
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .video-section {
            background-color: var(--card-background);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        .controls-section {
            background-color: var(--card-background);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        .video-section h2,
        .controls-section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 1.5rem;
            letter-spacing: -0.025em;
        }

        .video-container {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        #videoFeed {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            background: var(--background-color);
            min-height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--subtle-text-color);
            border: 2px dashed var(--border-color);
        }

        .control-group {
            margin-bottom: 2rem;
        }

        .control-group h3 {
            color: var(--text-color);
            margin-bottom: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            font-family: "Poppins", sans-serif;
        }

        .btn:hover {
            background-color: #3b66cc;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 128, 255, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: #c82333;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .btn-warning:hover {
            background-color: #e0a800;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .status {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .status.connected {
            background-color: #d4edda;
            color: var(--success-color);
            border-color: #c3e6cb;
        }

        .status.disconnected {
            background-color: #f8d7da;
            color: var(--danger-color);
            border-color: #f5c6cb;
        }

        .status.processing {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }

        select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            background: var(--card-background);
            color: var(--text-color);
            transition: border-color 0.2s ease;
            font-family: "Poppins", sans-serif;
        }

        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 128, 255, 0.1);
        }

        /* Estilos para el control deslizante de deduplicaci√≥n */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border-color);
            outline: none;
            margin: 0.5rem 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: background 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: #3b66cc;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow);
        }

        .plates-section {
            background-color: var(--card-background);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow);
            grid-column: span 2;
        }

        .plates-section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 1.5rem;
            letter-spacing: -0.025em;
        }

        .plates-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .plates-table th,
        .plates-table td {
            text-align: left;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .plates-table th {
            background-color: var(--background-color);
            font-weight: 600;
            color: var(--text-color);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.8rem;
        }

        .plates-table tbody tr:hover {
            background-color: var(--background-color);
        }

        .plate-text {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-weight: 600;
            font-size: 1rem;
            color: var(--primary-color);
            background: var(--background-color);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--background-color);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--subtle-text-color);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 400;
        }

        #systemStatus {
            background: var(--background-color);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        #systemStatus p {
            margin: 0.5rem 0;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }

        #systemStatus strong {
            color: var(--text-color);
            font-weight: 600;
        }

        .view-btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, #3b66cc 100%);
            border: 1px solid var(--border-color);
            color: white;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            padding: 6px 10px;
            border-radius: 6px;
            transition: all 0.2s ease;
            margin: 1px;
            min-width: 42px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            text-decoration: none;
            white-space: nowrap;
        }

        .view-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(74, 128, 255, 0.3);
        }

        .view-btn.delete {
            background: linear-gradient(135deg, var(--danger-color) 0%, #c82333 100%);
        }

        .view-btn.delete:hover {
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }

        .view-btn.consult {
            background: linear-gradient(135deg, var(--success-color) 0%, #1e7e34 100%);
        }

        .view-btn.consult:hover {
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .actions-column {
            width: 180px;
            text-align: center;
            padding: 0.25rem;
        }

        .actions-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2px;
            flex-wrap: nowrap;
            white-space: nowrap;
        }

        .actions-column {
            width: 180px;
            text-align: center;
            padding: 4px;
        }

        .actions-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2px;
            flex-wrap: nowrap;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .plates-section {
                grid-column: span 1;
            }

            .header h1 {
                font-size: 2rem;
            }
        }

        /* Estilos para el modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: relative;
            background-color: var(--card-background);
            margin: 2% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close-btn {
            background: var(--background-color);
            border: 1px solid var(--border-color);
            font-size: 20px;
            cursor: pointer;
            color: var(--subtle-text-color);
            transition: all 0.2s ease;
            padding: 0.5rem;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .close-btn:hover {
            color: var(--text-color);
            background-color: var(--border-color);
        }

        .modal-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .modal-body {
            text-align: center;
        }

        .modal-body p {
            margin: 0.5rem 0;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        /* Estilos para modal de consulta SUNARP */
        .sunarp-info {
            background: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .sunarp-info h4 {
            color: var(--text-color);
            margin-bottom: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }

        .info-label {
            font-weight: 600;
            color: var(--text-color);
        }

        .info-value {
            color: var(--text-color);
            text-align: right;
        }

        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2.5rem;
            color: var(--subtle-text-color);
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: var(--danger-color);
            padding: 0.75rem;
            border-radius: 6px;
            margin: 1rem 0;
            text-align: center;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .plates-section {
                grid-column: span 1;
            }

            .header h1 {
                font-size: 2rem;
            }

            .stats {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        /* Loader mejorado */
        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            margin: 2rem auto;
            animation: spin 1s linear infinite;
        }

        /* Botones de exportar */
        .export-btn {
            padding: 0.5rem 1rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-family: "Poppins", sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .export-btn:hover {
            background-color: #3b66cc;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Dashboard de Reconocimiento de Placas</h1>
            <p>Sistema automatizado para detecci√≥n y an√°lisis de matr√≠culas vehiculares</p>
        </div>

        <div class="dashboard-grid">
            <div class="video-section">
                <h2>Video en Tiempo Real</h2>
                <div class="video-container">
                    <div id="videoFeed">
                        Conectando con la c√°mara...
                    </div>
                </div>

                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalPlates">0</div>
                        <div class="stat-label">Total Placas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="sessionPlates">0</div>
                        <div class="stat-label">Esta Sesi√≥n</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="fps">0</div>
                        <div class="stat-label">FPS</div>
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <h2>Controles</h2>

                <div id="connectionStatus" class="status disconnected">
                    <span class="loading"></span>
                    Conectando al servidor...
                </div>

                <div class="control-group">
                    <h3>Fuente de C√°mara</h3>
                    <select id="cameraSelect">
                        <option value="webcam">Webcam</option>
                        <option value="ip_cam_cellphone">C√°mara IP</option>
                    </select>
                </div>

                <div class="control-group">
                    <h3>Control de Video</h3>
                    <button id="startBtn" class="btn">‚ñ∂ Iniciar</button>
                    <button id="stopBtn" class="btn btn-danger" style="display: none;">‚èπ Detener</button>
                </div>

                <div class="control-group">
                    <h3>Estado del Sistema</h3>
                    <div id="systemStatus">
                        <p><strong>Procesamiento:</strong> <span id="processingStatus">Detenido</span></p>
                        <p><strong>C√°mara Activa:</strong> <span id="activeCamera">Ninguna</span></p>
                        <p><strong>√öltima Detecci√≥n:</strong> <span id="lastDetection">--</span></p>
                        <p><strong>Total Placas:</strong> <span id="totalPlates">0</span></p>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Base de Datos</h3>
                    <button id="clearDbBtn" class="btn btn-warning">üóë Limpiar BD</button>
                    <button id="refreshPlatesBtn" class="btn">üîÑ Actualizar</button>
                </div>

                <div class="control-group">
                    <h3>Configuraci√≥n Anti-Duplicados</h3>
                    <div style="margin-bottom: 12px;">
                        <label for="dedupTime"
                            style="display: block; font-size: 0.75rem; color: #4a5568; margin-bottom: 4px;">
                            Tiempo de deduplicaci√≥n (segundos):
                        </label>
                        <input type="range" id="dedupTime" min="5" max="120" value="30"
                            style="width: 100%; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #718096;">
                            <span>5s</span>
                            <span id="dedupTimeValue">30s</span>
                            <span>120s</span>
                        </div>
                    </div>
                    <button id="updateDedupBtn" class="btn">üíæ Aplicar</button>
                    <button id="clearCacheBtn" class="btn btn-warning" style="margin-left: 8px;">üßπ Limpiar
                        Cache</button>
                    <p style="font-size: 0.75rem; color: #718096; margin-top: 8px;">
                        Evita registrar la misma placa m√∫ltiples veces en el tiempo especificado.
                        <br><span id="cacheStatus">Cache: 0 elementos</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="plates-section">
            <h2>Placas Detectadas Recientemente</h2>
            <table class="plates-table">
                <thead>
                    <tr>
                        <th>Placa</th>
                        <th>Fecha y Hora</th>
                        <th>C√°mara</th>
                        <th>Estado</th>
                        <th class="actions-column">Acciones</th>
                    </tr>
                </thead>
                <tbody id="platesTableBody">
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #718096;">
                            No hay placas detectadas a√∫n
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal para visualizar im√°genes -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Imagen Capturada</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody" class="modal-body">
                <img id="modalImage" class="modal-image" src="" alt="Imagen de placa">
                <div style="margin-top: 16px;">
                    <p><strong>Placa:</strong> <span id="modalPlateText"></span></p>
                    <p><strong>Fecha:</strong> <span id="modalDateTime"></span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para consulta SUNARP -->
    <div id="sunarpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Consulta Vehicular - SUNARP</h3>
                <button class="close-btn" onclick="closeSunarpModal()">&times;</button>
            </div>
            <div id="sunarpModalBody" class="modal-body">
                <p><strong>Placa:</strong> <span id="sunarpPlateText"></span></p>
                <div id="sunarpContent">
                    <!-- El contenido se cargar√° din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n del WebSocket
        const socket = io();

        // Referencias a elementos del DOM
        const videoFeed = document.getElementById('videoFeed');
        const connectionStatus = document.getElementById('connectionStatus');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const cameraSelect = document.getElementById('cameraSelect');
        const platesTableBody = document.getElementById('platesTableBody');
        const totalPlatesCounter = document.getElementById('totalPlates');
        const sessionPlatesCounter = document.getElementById('sessionPlates');
        const fpsCounter = document.getElementById('fps');
        const processingStatus = document.getElementById('processingStatus');
        const activeCamera = document.getElementById('activeCamera');
        const lastDetection = document.getElementById('lastDetection');
        const clearDbBtn = document.getElementById('clearDbBtn');
        const refreshPlatesBtn = document.getElementById('refreshPlatesBtn');
        const dedupTimeSlider = document.getElementById('dedupTime');
        const dedupTimeValue = document.getElementById('dedupTimeValue');
        const updateDedupBtn = document.getElementById('updateDedupBtn');
        const clearCacheBtn = document.getElementById('clearCacheBtn');
        const cacheStatus = document.getElementById('cacheStatus');

        // Variables de estado
        let sessionPlatesCount = 0;
        let lastFrameTime = Date.now();
        let frameCount = 0;

        // Eventos del WebSocket
        socket.on('connect', () => {
            console.log('Conectado al servidor');
            connectionStatus.className = 'status connected';
            connectionStatus.innerHTML = '‚óè Conectado';
            loadInitialPlates();
        });

        socket.on('disconnect', () => {
            console.log('Desconectado del servidor');
            connectionStatus.className = 'status disconnected';
            connectionStatus.innerHTML = '‚óè Desconectado';
            videoFeed.innerHTML = 'Conexi√≥n perdida...';
        });

        socket.on('video_frame', (data) => {
            const img = new Image();
            img.onload = () => {
                videoFeed.innerHTML = '';
                videoFeed.appendChild(img);

                // Calcular FPS
                frameCount++;
                const now = Date.now();
                if (now - lastFrameTime >= 1000) {
                    fpsCounter.textContent = frameCount;
                    frameCount = 0;
                    lastFrameTime = now;
                }
            };
            img.src = 'data:image/jpeg;base64,' + data.image;
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.borderRadius = '10px';
        });

        socket.on('new_plate', (data) => {
            console.log('Nueva placa detectada:', data);
            data.plates.forEach(plate => {
                addPlateToTable(plate);
                sessionPlatesCount++;
                sessionPlatesCounter.textContent = sessionPlatesCount;
                lastDetection.textContent = new Date().toLocaleTimeString();
            });
        });

        socket.on('status_update', (data) => {
            console.log('Actualizaci√≥n de estado:', data);
            processingStatus.textContent = data.processing_active ? 'Activo' : 'Detenido';
            activeCamera.textContent = data.active_camera || 'Ninguna';

            if (data.processing_active) {
                connectionStatus.className = 'status processing';
                connectionStatus.innerHTML = '‚óè Procesando...';
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
            } else {
                connectionStatus.className = 'status connected';
                connectionStatus.innerHTML = '‚óè Conectado';
                startBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
                videoFeed.innerHTML = 'Video detenido. Presiona "Iniciar" para comenzar.';
            }
        });

        // Evento para actualizaci√≥n de base de datos
        socket.on('database_updated', (data) => {
            console.log('Base de datos actualizada:', data);
            totalPlatesCounter.textContent = data.total_plates;

            // Actualizar tambi√©n el contador en el estado del sistema
            const systemTotalPlates = document.getElementById('totalPlates');
            if (systemTotalPlates) {
                systemTotalPlates.textContent = data.total_plates;
            }

            if (data.action === 'clear') {
                // Limpiar la tabla si se limpiaron todos los registros
                platesTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #718096;">No hay placas detectadas a√∫n</td></tr>';
            } else if (data.action === 'delete') {
                // Recargar la tabla despu√©s de eliminar un registro
                loadInitialPlates();
            }
        });

        // Evento espec√≠fico para limpiar placas
        socket.on('plates_cleared', (data) => {
            console.log('Placas limpiadas:', data);
            totalPlatesCounter.textContent = data.count;
            sessionPlatesCounter.textContent = 0; // Tambi√©n resetear contador de sesi√≥n
            sessionPlatesCount = 0;

            // Limpiar la tabla
            platesTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #718096;">No hay placas detectadas a√∫n</td></tr>';
        });

        // Eventos de los controles
        startBtn.addEventListener('click', () => {
            const selectedCamera = cameraSelect.value;
            console.log('Iniciando stream con c√°mara:', selectedCamera);
            socket.emit('control_stream', {
                action: 'start',
                camera_source: selectedCamera
            });
        });

        stopBtn.addEventListener('click', () => {
            console.log('Deteniendo stream');
            socket.emit('control_stream', {
                action: 'stop'
            });
        });

        cameraSelect.addEventListener('change', () => {
            const selectedCamera = cameraSelect.value;
            console.log('Cambiando c√°mara a:', selectedCamera);
            socket.emit('control_stream', {
                action: 'switch_camera',
                camera_source: selectedCamera
            });
        });

        // Eventos para los botones de base de datos
        clearDbBtn.addEventListener('click', () => {
            if (confirm('¬øEst√°s seguro de que quieres limpiar toda la base de datos? Esta acci√≥n no se puede deshacer.')) {
                fetch('/api/plates/clear', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Base de datos limpiada exitosamente');
                            loadInitialPlates(); // Recargar la tabla
                            updatePlatesCount(); // Actualizar contador
                        } else {
                            alert('Error al limpiar la base de datos: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error de conexi√≥n al limpiar la base de datos');
                    });
            }
        });

        refreshPlatesBtn.addEventListener('click', () => {
            loadInitialPlates();
            updatePlatesCount();
        });

        // Eventos para configuraci√≥n de deduplicaci√≥n
        dedupTimeSlider.addEventListener('input', (e) => {
            dedupTimeValue.textContent = e.target.value + 's';
        });

        updateDedupBtn.addEventListener('click', () => {
            const dedupTime = parseInt(dedupTimeSlider.value);

            fetch('/api/settings/deduplication', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    deduplication_time: dedupTime
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`‚úÖ ${data.message}`);
                    } else {
                        alert(`‚ùå Error: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error de conexi√≥n al actualizar configuraci√≥n');
                });
        });

        clearCacheBtn.addEventListener('click', () => {
            if (confirm('¬øEst√°s seguro de que quieres limpiar el cache de deduplicaci√≥n? Esto permitir√° detectar placas que estaban siendo filtradas.')) {
                fetch('/api/cache/clear', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(`‚úÖ ${data.message}`);
                            updateCacheStatus(); // Actualizar el estado del cache
                        } else {
                            alert(`‚ùå Error: ${data.message}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error de conexi√≥n al limpiar cache');
                    });
            }
        });

        // Funciones auxiliares
        function addPlateToTable(plate) {
            // Si es la primera placa, limpiar el mensaje de "No hay placas"
            if (platesTableBody.children.length === 1 && platesTableBody.children[0].children.length === 1) {
                platesTableBody.innerHTML = '';
            }

            const timestamp = new Date().toLocaleString();
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><span class="plate-text">${plate.plate}</span></td>
                <td>${timestamp}</td>
                <td>${plate.camera}</td>
                <td>Nueva</td>
                <td class="actions-column">
                    <div class="actions-row">
                        <button class="view-btn" onclick="openModal('${plate.plate}', '${timestamp}', '${plate.image || ''}')" title="Ver imagen">
                            üëÅ Ver
                        </button>
                        <button class="view-btn delete" onclick="deletePlate('${plate.plate}', '${timestamp}')" title="Eliminar">
                            üóë Del
                        </button>
                        <button class="view-btn consult" onclick="consultSunarp('${plate.plate}')" title="Consultar SUNARP">
                            üîç SUNARP
                        </button>
                    </div>
                </td>
            `;

            // Insertar al principio de la tabla
            platesTableBody.insertBefore(row, platesTableBody.firstChild);

            // Limitar a 20 filas m√°ximo
            while (platesTableBody.children.length > 20) {
                platesTableBody.removeChild(platesTableBody.lastChild);
            }

            // Efecto de highlight para la nueva fila
            row.style.backgroundColor = '#e6fffa';
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 2000);
        }

        function loadInitialPlates() {
            fetch('/api/plates')
                .then(response => response.json())
                .then(plates => {
                    console.log('Placas cargadas:', plates);

                    if (plates.length > 0) {
                        platesTableBody.innerHTML = '';
                        plates.forEach(plate => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td><span class="plate-text">${plate.plate}</span></td>
                                <td>${new Date(plate.timestamp).toLocaleString()}</td>
                                <td>${plate.camera}</td>
                                <td>Almacenada</td>
                                <td class="actions-column">
                                    <div class="actions-row">
                                        <button class="view-btn" onclick="openModal('${plate.plate}', '${new Date(plate.timestamp).toLocaleString()}', '${plate.image_base64 || ''}')" title="Ver imagen">
                                            üëÅ Ver
                                        </button>
                                        <button class="view-btn delete" onclick="deletePlate('${plate.plate}', '${plate.timestamp}')" title="Eliminar">
                                            üóë Del
                                        </button>
                                        <button class="view-btn consult" onclick="consultSunarp('${plate.plate}')" title="Consultar SUNARP">
                                            üîç SUNARP
                                        </button>
                                    </div>
                                </td>
                            `;
                            platesTableBody.appendChild(row);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error al cargar placas:', error);
                });
        }

        function updatePlatesCount() {
            fetch('/api/plates/count')
                .then(response => response.json())
                .then(data => {
                    totalPlatesCounter.textContent = data.count;
                })
                .catch(error => {
                    console.error('Error al obtener contador:', error);
                });
        }

        function loadDeduplicationSettings() {
            fetch('/api/settings/deduplication')
                .then(response => response.json())
                .then(data => {
                    if (data.deduplication_time) {
                        dedupTimeSlider.value = data.deduplication_time;
                        dedupTimeValue.textContent = data.deduplication_time + 's';
                    }
                })
                .catch(error => {
                    console.error('Error al cargar configuraci√≥n de deduplicaci√≥n:', error);
                });
        }

        function updateCacheStatus() {
            fetch('/api/cache/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        cacheStatus.textContent = `Cache: ${data.cache_size} elementos`;
                    }
                })
                .catch(error => {
                    console.error('Error al obtener estad√≠sticas del cache:', error);
                });
        }

        // Funciones del modal
        function openModal(plateText, dateTime, imageBase64) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalPlateText = document.getElementById('modalPlateText');
            const modalDateTime = document.getElementById('modalDateTime');

            // Configurar contenido del modal
            modalPlateText.textContent = plateText;
            modalDateTime.textContent = dateTime;

            if (imageBase64 && imageBase64 !== '') {
                modalImage.src = 'data:image/jpeg;base64,' + imageBase64;
                modalImage.style.display = 'block';
            } else {
                modalImage.style.display = 'none';
                modalImage.src = '';
                // Mostrar mensaje de imagen no disponible
                modalImage.insertAdjacentHTML('afterend',
                    '<p style="text-align: center; color: #718096; padding: 40px;">Imagen no disponible</p>');
            }

            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Evitar scroll del fondo
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // Restaurar scroll

            // Limpiar mensaje de imagen no disponible si existe
            const noImageMsg = modal.querySelector('p');
            if (noImageMsg && noImageMsg.textContent.includes('Imagen no disponible')) {
                noImageMsg.remove();
            }
        }

        // Cerrar modal al hacer clic fuera de √©l
        window.onclick = function (event) {
            const imageModal = document.getElementById('imageModal');
            const sunarpModal = document.getElementById('sunarpModal');

            if (event.target === imageModal) {
                closeModal();
            }
            if (event.target === sunarpModal) {
                closeSunarpModal();
            }
        }

        // Cerrar modal con la tecla Escape
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                closeModal();
                closeSunarpModal();
            }
        });

        // Funci√≥n para eliminar una placa
        function deletePlate(plateText, timestamp) {
            if (confirm(`¬øEst√°s seguro de que quieres eliminar la placa ${plateText}?`)) {
                fetch('/api/plates/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        plate: plateText,
                        timestamp: timestamp
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Placa eliminada exitosamente');
                            loadInitialPlates(); // Recargar la tabla
                            updatePlatesCount(); // Actualizar contador
                        } else {
                            alert('Error al eliminar la placa: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error de conexi√≥n al eliminar la placa');
                    });
            }
        }

        // Funci√≥n para consultar en SUNARP
        function consultSunarp(plateText) {
            const modal = document.getElementById('sunarpModal');
            const sunarpPlateText = document.getElementById('sunarpPlateText');
            const sunarpContent = document.getElementById('sunarpContent');

            // Configurar el modal
            sunarpPlateText.textContent = plateText;
            sunarpContent.innerHTML = `
                <div class="loading-spinner">
                    <div class="loading"></div>
                    <span style="margin-left: 12px;">Consultando informaci√≥n vehicular en SUNARP...</span>
                </div>
            `;

            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';

            // Realizar consulta al backend
            fetch('/api/sunarp/consult', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ plate: plateText })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const info = data.data;
                        let screenshotHtml = '';

                        // Mostrar screenshot si est√° disponible
                        if (data.screenshot) {
                            // Decodificar el HTML capturado
                            const decodedHtml = atob(data.screenshot);
                            screenshotHtml = `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="margin-bottom: 12px;">Captura de SUNARP</h4>
                                    <div style="max-width: 100%; border-radius: 8px; border: 1px solid #e2e8f0; max-height: 300px; overflow-y: auto; background: #f8f9fa;">
                                        ${decodedHtml}
                                    </div>
                                </div>
                            `;
                        }

                        sunarpContent.innerHTML = `
                        ${screenshotHtml}
                        <div class="sunarp-info">
                            <h4>Informaci√≥n del Veh√≠culo</h4>
                            <div class="info-row">
                                <span class="info-label">Placa:</span>
                                <span class="info-value">${info.placa || 'No disponible'}</span>
                            </div>
                            ${info.serie ? `
                            <div class="info-row">
                                <span class="info-label">N¬∞ Serie:</span>
                                <span class="info-value">${info.serie}</span>
                            </div>
                            ` : ''}
                            ${info.vin ? `
                            <div class="info-row">
                                <span class="info-label">N¬∞ VIN:</span>
                                <span class="info-value">${info.vin}</span>
                            </div>
                            ` : ''}
                            ${info.motor ? `
                            <div class="info-row">
                                <span class="info-label">N¬∞ Motor:</span>
                                <span class="info-value">${info.motor}</span>
                            </div>
                            ` : ''}
                            ${info.propietario ? `
                            <div class="info-row">
                                <span class="info-label">Propietario:</span>
                                <span class="info-value">${info.propietario}</span>
                            </div>
                            ` : ''}
                            <div class="info-row">
                                <span class="info-label">Marca:</span>
                                <span class="info-value">${info.marca || 'No disponible'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Modelo:</span>
                                <span class="info-value">${info.modelo || 'No disponible'}</span>
                            </div>
                            ${info.a√±o ? `
                            <div class="info-row">
                                <span class="info-label">A√±o:</span>
                                <span class="info-value">${info.a√±o}</span>
                            </div>
                            ` : ''}
                            <div class="info-row">
                                <span class="info-label">Color:</span>
                                <span class="info-value">${info.color || 'No disponible'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Estado:</span>
                                <span class="info-value">${info.estado || 'No disponible'}</span>
                            </div>
                            ${info.placa_vigente ? `
                            <div class="info-row">
                                <span class="info-label">Placa Vigente:</span>
                                <span class="info-value">${info.placa_vigente}</span>
                            </div>
                            ` : ''}
                            ${info.placa_anterior ? `
                            <div class="info-row">
                                <span class="info-label">Placa Anterior:</span>
                                <span class="info-value">${info.placa_anterior}</span>
                            </div>
                            ` : ''}
                            ${info.sede ? `
                            <div class="info-row">
                                <span class="info-label">Sede:</span>
                                <span class="info-value">${info.sede}</span>
                            </div>
                            ` : ''}
                            ${info.anotaciones ? `
                            <div class="info-row">
                                <span class="info-label">Anotaciones:</span>
                                <span class="info-value">${info.anotaciones}</span>
                            </div>
                            ` : ''}
                        </div>
                    `;
                    } else {
                        sunarpContent.innerHTML = `
                        <div class="error-message">
                            ${data.message || 'No se pudo obtener informaci√≥n del veh√≠culo'}
                        </div>
                    `;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    sunarpContent.innerHTML = `
                    <div class="error-message">
                        Error de conexi√≥n al consultar SUNARP
                    </div>
                `;
                });
        }

        // Funci√≥n para cerrar modal SUNARP
        function closeSunarpModal() {
            const modal = document.getElementById('sunarpModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Inicializaci√≥n
        loadInitialPlates();
        updatePlatesCount();
        loadDeduplicationSettings();
        updateCacheStatus();

        // Actualizar estado del cache cada 10 segundos
        setInterval(updateCacheStatus, 10000);

        console.log('Dashboard inicializado');
    </script>
</body>

</html>